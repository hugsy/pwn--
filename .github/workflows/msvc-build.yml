name: CI Build for MSVC

env:
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
  REPO: hugsy/pwn--
  RUN_URL: https://github.com/hugsy/pwn--/runs/${{ github.run_number }}

on:
  push:
    branches: [master, dev]
  pull_request:
    branches: [master, dev]


jobs:
  build:
    name: "Building pwn++ for ${{ matrix.configuration }}/${{ matrix.platform }}"
    runs-on: windows-latest
    strategy:
      fail-fast: true
      matrix:
        platform: ['x86', 'x64']
        configuration: ['Debug', 'Release']

    steps:
    - uses: actions/checkout@v2

    - name: Inject slug/short variables
      uses: rlespinasse/github-slug-action@v3.x

    - name: Install dependencies
      shell: pwsh
      run: |
        vcpkg integrate install
        vcpkg install keystone:${{ matrix.platform }}-windows-static
        vcpkg install capstone:${{ matrix.platform }}-windows-static

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v1
      with:
        languages: cpp

    - name: Build pwn++ lib & dll
      shell: pwsh
      run: |
        Import-Module .\.github\Invoke-VS.ps1
        New-Item -ItemType SymbolicLink -Target "..\pwn--" -Path "..\pwn++" -ErrorAction Continue
        Invoke-VisualStudio2019${{ matrix.platform }}
        msbuild.exe pwn++\pwn++.vcxproj -nologo /m /p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }}

    - name: Notify on build failure
      if: ${{ failure() }}
      uses: sarisia/actions-status-discord@v1
      with:
        nodetail: true
        title: CI failed on `${{ github.ref }}`
        description: |
          Failed to compile `${{ github.ref }}`
          ---
          See ${{ env.RUN_URL }} for details
        color: 0xff0000
        username: ${{ github.actor }} via GithubBot
        avatar_url: ${{ github.actor.avatar_url }}

    - name: Run tests
      shell: pwsh
      run: |
        Import-Module .\.github\Invoke-VS.ps1
        Invoke-VisualStudio2019${{ matrix.platform }}
        msbuild.exe pwn++-tests\pwn++-tests.vcxproj -nologo /m /p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }}
        Copy-Item pwn++\${{ matrix.platform }}\${{ matrix.configuration }}\pwn++.dll pwn++-tests\${{ matrix.platform }}\${{ matrix.configuration }}\
        vstest.console.exe /Platform:${{ matrix.platform }} .\pwn++-tests\${{ matrix.platform }}\${{ matrix.configuration }}\pwn++-tests.dll

    - name: Perform CodeQL Analysis
      if: ${{ success() }}
      uses: github/codeql-action/analyze@v1

    - name: Notify on test failure
      if: ${{ failure() }}
      uses: sarisia/actions-status-discord@v1
      with:
        nodetail: true
        title: CI failed on `${{ github.ref }}`
        description: |
          Tests failed for `${{ github.ref }}`
          ---
          See ${{ env.RUN_URL }} for details
        color: 0xff0000
        username: ${{ github.actor }} via GithubBot
        avatar_url: ${{ github.actor.avatar_url }}

    - name: Prepare artifact
      id: prepare_artifact
      shell: pwsh
      run: |
        New-Item -Type Directory -Name build\
        Copy-Item pwn++\${{ matrix.platform }}\${{ matrix.configuration }}\pwn++.lib build\
        Copy-Item pwn++\${{ matrix.platform }}\${{ matrix.configuration }}\pwn++.dll build\
        Copy-Item pwn++\${{ matrix.platform }}\${{ matrix.configuration }}\pwn++.pdb build\
        New-Item -Type Directory -Name build\include\
        Copy-Item pwn++\*.h build\include\

    - name: Publish artifact
      id: publish_artifact
      uses: actions/upload-artifact@v2
      with:
        name: pwn++_msvc_${{ env.GITHUB_REF_SLUG }}_${{ matrix.platform }}_${{ env.GITHUB_SHA_SHORT }}
        path: build\

    - name: Notify on success
      if: ${{ success() }}
      uses: sarisia/actions-status-discord@v1
      with:
        nodetail: true
        title: Build `${{ github.ref }}` succeeded
        description: |
          Tests failed for `${{ github.ref }}`
          ---
          See ${{ env.RUN_URL }} for details
        color: 0x00ff00
        username: ${{ github.actor }} via GithubBot
        avatar_url: ${{ github.actor.avatar_url }}

