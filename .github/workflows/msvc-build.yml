name: CI Build for MSVC

env:
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

on:
  push:
    branches: [master, dev]

jobs:
  build:
    name: "Building pwn++"
    runs-on: [windows-latest]
    strategy:
      fail-fast: true
      matrix:
        platform: ['x86', 'x64']
        configuration: ['Debug', 'Release']

    steps:
    - uses: actions/checkout@v2

    - name: Inject slug/short variables
      uses: rlespinasse/github-slug-action@v3.x

    - name: Build Capstone lib
      shell: pwsh
      run: |
        Import-Module .\.github\Invoke-VS.ps1
        cd ..
        git clone https://github.com/aquynh/capstone
        cd .\capstone\msvc
        Invoke-VisualStudio2019${{ matrix.platform }}
        devenv capstone.sln -nologo /resetsettings
        devenv capstone.sln -nologo /upgrade
        msbuild capstone_static/capstone_static.vcxproj -m -nologo /p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }}

    - name: Build Keystone lib
      shell: pwsh
      run: |
        Import-Module .\.github\Invoke-VS.ps1
        cd ..
        git clone https://github.com/keystone-engine/keystone
        Invoke-VisualStudio2019${{ matrix.platform }}
        mkdir .\keystone\build
        cd .\keystone\build
        ..\nmake-lib.bat

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v1
      with:
        languages: cpp

    - name: Build pwn++ lib & dll
      shell: pwsh
      run: |
        Import-Module .\.github\Invoke-VS.ps1
        New-Item -ItemType SymbolicLink -Target "..\pwn--" -Path "..\pwn++" -ErrorAction Continue
        Invoke-VisualStudio2019${{ matrix.platform }}
        msbuild.exe pwn++\pwn++.vcxproj -nologo /m /p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }}

    - name: Notify on build failure
      if: ${{ failure() }}
      uses: sarisia/actions-status-discord@v1
        with:
          nodetail: true
          title: CI failed on `${{ github.ref }}`
          description: |
            Failed to compile `${{ github.ref }}`

            See ${{ github.event.push.html_url }}
          color: 0xff0000
          username: ${{ github.actor }} via GithubBot
          avatar_url: ${{ github.actor.avatar_url }}

    - name: Run tests
      shell: pwsh
      run: |
        Import-Module .\.github\Invoke-VS.ps1
        Invoke-VisualStudio2019${{ matrix.platform }}
        msbuild.exe pwn++-tests\pwn++-tests.vcxproj -nologo /m /p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }}
        Copy-Item pwn++\${{ matrix.platform }}\${{ matrix.configuration }}\pwn++.dll pwn++-tests\${{ matrix.platform }}\${{ matrix.configuration }}\
        vstest.console.exe /Platform:${{ matrix.platform }} .\pwn++-tests\${{ matrix.platform }}\${{ matrix.configuration }}\pwn++-tests.dll

    - name: Notify on test failure
      if: ${{ failure() }}
      uses: sarisia/actions-status-discord@v1
      with:
        nodetail: true
        title: CI failed on `${{ github.ref }}`
        description: |
          Tests failed for `${{ github.ref }}`
          See ${{ github.event.push.html_url }}
        color: 0xff0000
        username: ${{ github.actor }} via GithubBot
        avatar_url: ${{ github.actor.avatar_url }}

    - name: Prepare artifact
      id: prepare_artifact
      shell: pwsh
      run: |
        New-Item -Type Directory -Name build\
        New-Item -Type Directory -Name build\include\
        Copy-Item pwn++\${{ matrix.platform }}\${{ matrix.configuration }}\pwn++.lib build\
        Copy-Item pwn++\${{ matrix.platform }}\${{ matrix.configuration }}\pwn++.dll build\
        Copy-Item pwn++\*.h build\include\

    - name: Publish artifact
      id: publish_artifact
      uses: actions/upload-artifact@v2
      with:
        name: pwn++_msvc_${{ env.GITHUB_REF_SLUG }}_${{ matrix.platform }}_${{ env.GITHUB_SHA_SHORT }}
        path: build\

    - name: Notify on success
      if: ${{ success() }}
      uses: sarisia/actions-status-discord@v1
      with:
        nodetail: true
        title: Build `${{ github.ref }}` succeeded
        description: |
          Tests failed for `${{ github.ref }}`
          See ${{ github.event.push.html_url }}
        color: 0x00ff00
        username: ${{ github.actor }} via GithubBot
        avatar_url: ${{ github.actor.avatar_url }}

